<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Solar System Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

  <div class="bg-white shadow-lg rounded-2xl p-6 w-full max-w-lg">
    <h1 class="text-xl font-bold mb-4 text-center">⚡ Solar System Calculator</h1>

    <!-- Country dropdown -->
    <div class="relative w-full mb-4">
      <label class="block mb-2 font-medium text-sm">Country:</label>
      <div id="dropdownButton" class="w-full p-3 border rounded-lg cursor-pointer bg-white">-- Select Country --</div>

      <div id="dropdownMenu" class="absolute z-10 w-full bg-white border rounded-lg mt-1 hidden max-h-60 overflow-y-auto shadow-lg">
        <input type="text" id="countrySearch" placeholder="Search country..." class="w-full p-2 border-b outline-none" />
        <div id="countryOptions" class="text-sm">
          <div class="p-2 hover:bg-blue-100 cursor-pointer" data-value="Australia">Australia</div>
          <div class="p-2 hover:bg-blue-100 cursor-pointer" data-value="Brazil">Brazil</div>
          <div class="p-2 hover:bg-blue-100 cursor-pointer" data-value="Canada">Canada</div>
          <div class="p-2 hover:bg-blue-100 cursor-pointer" data-value="China">China</div>
          <div class="p-2 hover:bg-blue-100 cursor-pointer" data-value="Egypt">Egypt</div>
          <div class="p-2 hover:bg-blue-100 cursor-pointer" data-value="Germany">Germany</div>
          <div class="p-2 hover:bg-blue-100 cursor-pointer" data-value="Ghana">Ghana</div>
          <div class="p-2 hover:bg-blue-100 cursor-pointer" data-value="India">India</div>
          <div class="p-2 hover:bg-blue-100 cursor-pointer" data-value="Japan">Japan</div>
          <div class="p-2 hover:bg-blue-100 cursor-pointer" data-value="Kenya">Kenya</div>
          <div class="p-2 hover:bg-blue-100 cursor-pointer" data-value="Mexico">Mexico</div>
          <div class="p-2 hover:bg-blue-100 cursor-pointer" data-value="Nigeria">Nigeria</div>
          <div class="p-2 hover:bg-blue-100 cursor-pointer" data-value="SouthAfrica">South Africa</div>
          <div class="p-2 hover:bg-blue-100 cursor-pointer" data-value="UK">United Kingdom</div>
          <div class="p-2 hover:bg-blue-100 cursor-pointer" data-value="USA">United States</div>
        </div>
      </div>

      <!-- hidden value that the calculator reads -->
      <input type="hidden" id="country" />
    </div>

    <!-- Inputs -->
    <label class="block mb-2 font-medium">Load (W):</label>
    <input id="load" type="number" class="w-full p-3 border rounded-lg mb-4" placeholder="e.g. 500" />

    <label class="block mb-2 font-medium">Usage Time (Hours):</label>
    <input id="usageHrs" type="number" class="w-full p-3 border rounded-lg mb-4" placeholder="e.g. 5" />

    <label class="block mb-2 font-medium">Backup Hours (Autonomy):</label>
    <input id="backupHrs" type="number" class="w-full p-3 border rounded-lg mb-4" placeholder="e.g. 2" />

    <label class="block mb-2 font-medium">System Voltage (V):</label>
    <input id="systemV" type="number" class="w-full p-3 border rounded-lg mb-4" placeholder="e.g. 24" />

    <label class="block mb-2 font-medium">Solar Panel Wattage (Wp):</label>
    <input id="panelW" type="number" class="w-full p-3 border rounded-lg mb-4" placeholder="e.g. 300" />

    <label class="block mb-2 font-medium">Battery Voltage (V):</label>
    <input id="batteryV" type="number" class="w-full p-3 border rounded-lg mb-4" placeholder="e.g. 12" />

    <label class="block mb-2 font-medium">Battery Capacity (Ah):</label>
    <input id="batteryAh" type="number" class="w-full p-3 border rounded-lg mb-4" placeholder="e.g. 200" />

    <label class="block mb-2 font-medium">Battery Type:</label>
    <select id="batteryType" class="w-full p-3 border rounded-lg mb-4">
      <option value="tubular">Tubular (Lead-Acid)</option>
      <option value="lithium">Lithium</option>
    </select>

    <!-- Calculate button with spinner -->
    <button id="calculateBtn" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition flex items-center justify-center space-x-2">
      <span id="btnText">Calculate</span>
      <svg id="btnSpinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
    </button>

    <!-- Contact -->
    <div class="mt-6 text-center">
      <h2 class="text-lg font-semibold mb-3">Connect With Me</h2>
      <div class="flex justify-center space-x-3">
        <a href="https://wa.me/2348143369102" target="_blank" class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600">WhatsApp</a>
        <a href="https://www.instagram.com/tifeosame" target="_blank" class="bg-pink-500 text-white px-3 py-2 rounded-lg hover:bg-pink-600">Instagram</a>
        <a href="mailto:tonyifeosame@gmail.com" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600">Email</a>
      </div>
    </div>

    <!-- Results -->
    <div id="results" class="hidden mt-6 p-4 bg-gray-50 rounded-lg border transition-opacity duration-300 opacity-0"></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Elements
      const dropdownBtn = document.getElementById("dropdownButton");
      const dropdownMenu = document.getElementById("dropdownMenu");
      const countrySearch = document.getElementById("countrySearch");
      const countryOptions = Array.from(document.querySelectorAll("#countryOptions > div"));
      const hiddenCountry = document.getElementById("country");

      const calculateBtn = document.getElementById("calculateBtn");
      const btnText = document.getElementById("btnText");
      const btnSpinner = document.getElementById("btnSpinner");
      const resultsDiv = document.getElementById("results");

      // Inputs that reset the button on change
      const watchedInputs = Array.from(document.querySelectorAll('input:not([type="hidden"]), select'));

      // Sun hours by country (keys must match data-value)
      const sunHoursData = {
        Australia: 7, Brazil: 5.5, Canada: 4.5, China: 5, Egypt: 9,
        Germany: 3.5, Ghana: 7.5, India: 7.5, Japan: 4.5, Kenya: 8,
        Mexico: 6, Nigeria: 8, SouthAfrica: 7, UK: 4.5, USA: 6.5
      };

      // Dropdown behavior
      dropdownBtn.addEventListener("click", (e) => {
        dropdownMenu.classList.toggle("hidden");
        if (!dropdownMenu.classList.contains("hidden")) {
          countrySearch.focus();
          countrySearch.value = "";
          filterOptions("");
        }
      });

      countrySearch.addEventListener("input", () => {
        filterOptions(countrySearch.value.toLowerCase());
      });

      function filterOptions(search) {
        countryOptions.forEach(opt => {
          const txt = opt.innerText.toLowerCase();
          opt.style.display = txt.includes(search) ? "" : "none";
        });
      }

      countryOptions.forEach(opt => {
        opt.addEventListener("click", () => {
          dropdownBtn.innerText = opt.innerText;
          hiddenCountry.value = opt.getAttribute("data-value");
          dropdownMenu.classList.add("hidden");
          resetButton(); // selecting a country should reset the calculate button
        });
      });

      // Close dropdown if clicked outside
      document.addEventListener("click", (e) => {
        if (!e.target.closest("#dropdownMenu") && !e.target.closest("#dropdownButton")) {
          dropdownMenu.classList.add("hidden");
        }
      });

      // Reset button when any input changes
      watchedInputs.forEach(inp => {
        inp.addEventListener("input", resetButton);
        inp.addEventListener("change", resetButton);
      });

      function resetButton() {
        btnText.textContent = "Calculate";
        btnSpinner.classList.add("hidden");
        calculateBtn.disabled = false;
        calculateBtn.classList.remove("bg-green-500", "hover:bg-green-600");
        calculateBtn.classList.add("bg-blue-500", "hover:bg-blue-600");
      }

      // Main calculation
      calculateBtn.addEventListener("click", async () => {
        // Show spinner & disable
        btnText.textContent = "Calculating...";
        btnSpinner.classList.remove("hidden");
        calculateBtn.disabled = true;

        // tiny delay so spinner renders (and looks smooth)
        await new Promise(r => setTimeout(r, 120));

        // read values
        const load = parseFloat(document.getElementById("load").value);
        const usageHrs = parseFloat(document.getElementById("usageHrs").value);
        const backupHrs = parseFloat(document.getElementById("backupHrs").value);
        const systemV = parseFloat(document.getElementById("systemV").value);
        const panelW = parseFloat(document.getElementById("panelW").value);
        const batteryV = parseFloat(document.getElementById("batteryV").value);
        const batteryAh = parseFloat(document.getElementById("batteryAh").value);
        const batteryType = document.getElementById("batteryType").value;
        const country = hiddenCountry.value;

        // validate
        if (
          isNaN(load) || isNaN(usageHrs) || isNaN(backupHrs) ||
          isNaN(systemV) || isNaN(panelW) || isNaN(batteryV) || isNaN(batteryAh)
        ) {
          alert("⚠️ Please enter all values.");
          resetButton();
          return;
        }

        // choose battery profile
        let dod, efficiency;
        if (batteryType === "tubular") { dod = 0.5; efficiency = 0.85; }
        else { dod = 0.8; efficiency = 0.95; }

        // sun hours lookup
        const sunHours = sunHoursData[country] || 6;

        // core math
        const diversityFactor = 1.6;
        const adjustedLoad = load / diversityFactor;
        const dailyEnergy = adjustedLoad * usageHrs; // Wh/day
        const totalEnergy = adjustedLoad * backupHrs; // Wh needed to supply backupHrs
        const seriesBatteries = Math.max(1, Math.ceil(systemV / batteryV));
        const packWhPerString = batteryAh * batteryV * seriesBatteries;
        const usableWhPerString = packWhPerString * dod * efficiency;
        const parallelGroups = Math.max(1, Math.ceil(totalEnergy / usableWhPerString));
        const totalBatteries = seriesBatteries * parallelGroups;
        const inverterSize = Math.ceil(adjustedLoad * 1.2); // 20% margin
        const totalSolarWatt = (dailyEnergy / sunHours) * 1.1; // +10% margin for losses
        const numPanels = Math.max(0, Math.ceil(totalSolarWatt / panelW));

        // build results HTML (friendly formatting)
        const resultsHTML = `
          <h3 class="font-semibold mb-2">Results</h3>
          <p><strong>Country:</strong> ${country || "Not selected"} (Sun hours: ${sunHours})</p>
          <p><strong>Battery Type:</strong> ${batteryType === "tubular" ? "Tubular (Lead-Acid)" : "Lithium"}</p>
          <hr class="my-2" />
          <p><strong>Adjusted Load:</strong> ${adjustedLoad.toFixed(1)} W</p>
          <p><strong>Daily Energy:</strong> ${dailyEnergy.toFixed(1)} Wh (${(dailyEnergy/1000).toFixed(2)} kWh)</p>
          <p><strong>Backup Energy Needed:</strong> ${totalEnergy.toFixed(1)} Wh (${backupHrs} hrs)</p>
          <p><strong>Usable per Battery String:</strong> ${usableWhPerString.toFixed(0)} Wh</p>
          <p><strong>Batteries:</strong> ${totalBatteries} (${seriesBatteries} in series × ${parallelGroups} parallel)</p>
          <p><strong>Recommended Inverter:</strong> ${inverterSize} W</p>
          <p><strong>Solar Panels:</strong> ${numPanels} × ${panelW} Wp</p>
        `;

        // show results (fade in)
        resultsDiv.innerHTML = resultsHTML;
        resultsDiv.classList.remove("hidden");
        // trigger fade by setting opacity -> 1
        requestAnimationFrame(() => {
          resultsDiv.classList.remove("opacity-0");
          resultsDiv.classList.add("opacity-100");
        });

        // finish: update button to green + text
        btnText.textContent = "Calculated ✅";
        btnSpinner.classList.add("hidden");
        calculateBtn.disabled = false;
        calculateBtn.classList.remove("bg-blue-500", "hover:bg-blue-600");
        calculateBtn.classList.add("bg-green-500", "hover:bg-green-600");
      });
    });
  </script>
</body>
</html>
